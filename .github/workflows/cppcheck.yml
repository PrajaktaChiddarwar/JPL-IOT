name: Cppcheck

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  cppcheck:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install Cppcheck
      run: sudo apt-get install -y cppcheck

    - name: Run Cppcheck
      run: cppcheck --enable=all --inconclusive --xml --xml-version=2 . 2> cppcheck-result.xml

    - name: Upload Cppcheck results
      uses: actions/upload-artifact@v2
      with:
        name: cppcheck-result
        path: cppcheck-result.xml

    - name: Annotate Cppcheck results
      run: |
        echo "::group::Cppcheck Annotations"
        while IFS= read -r line; do
          file=$(echo "$line" | grep -oP 'file="\K[^"]+')
          line_number=$(echo "$line" | grep -oP 'line="\K[^"]+')
          message=$(echo "$line" | grep -oP 'msg="\K[^"]+')
          echo "::warning file=$file,line=$line_number::Cppcheck: $message"
        done < <(grep "<error " cppcheck-result.xml)
        echo "::endgroup::"
